<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root { --neon: #00f3ff; --pink: #ff00ff; --dark: #050a10; }
    body { background: var(--dark); color: var(--neon); font-family: 'Segoe UI', sans-serif; margin:0; overflow:hidden; height:100vh; display:flex; justify-content:center; align-items:center; }
    
    .view { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; position: absolute; }
    .active { display: flex; }
    .panel { border: 2px solid var(--neon); padding: 40px; background: rgba(0, 243, 255, 0.05); box-shadow: 0 0 20px var(--neon); text-align: center; border-radius: 10px; min-width: 350px; position: relative; }
    
    input { background: transparent; border: 1px solid var(--neon); color: #fff; padding: 12px; width: 80%; margin: 20px 0; outline: none; text-align: center; font-size: 1.1em; }
    .btn { background: transparent; border: 1px solid var(--neon); color: var(--neon); padding: 12px 30px; cursor: pointer; text-transform: uppercase; font-weight: bold; transition: 0.3s; margin: 5px; }
    .btn:hover { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
    
    /* 返回按鈕樣式 */
    .back-btn { position: absolute; top: 15px; left: 15px; font-size: 11px; border: 1px solid rgba(0,243,255,0.4); color: rgba(0,243,255,0.6); padding: 5px 12px; cursor: pointer; text-transform: uppercase; z-index: 200; }
    .back-btn:hover { color: var(--neon); border-color: var(--neon); }

    table { width: 100%; margin: 20px 0; border-collapse: collapse; }
    table td { border-bottom: 1px solid rgba(0, 243, 255, 0.2); padding: 10px; }
    
    #hud { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; font-family: monospace; font-size: 1.4em; z-index: 100; text-shadow: 0 0 5px #000; }
    #game-canvas { width: 100vw; height: 100vh; position: relative; cursor: crosshair; }
  </style>
</head>
<body>

  <!-- 1. 註冊畫面 -->
  <div id="view-reg" class="view active">
    <div class="panel">
      <h1 style="letter-spacing: 5px;">IDENTITY AUTH</h1>
      <input type="text" id="reg-name" placeholder="特工代號">
      <br>
      <button class="btn" onclick="handleAuth()">授權登入</button>
    </div>
  </div>

  <!-- 2. 排行榜畫面 -->
  <div id="view-lobby" class="view">
    <div class="panel">
      <div class="back-btn" onclick="goToView('view-reg')">登出 (Back)</div>
      <h2 style="color: var(--pink); text-shadow: 0 0 10px var(--pink);">全球戰力排行</h2>
      <div id="lb-data">系統讀取中...</div>
      <br>
      <button class="btn" style="width: 100%; font-size: 1.2em;" onclick="initGame()">開始訓練遊戲</button>
      <br><br>
      <small onclick="handleDelete()" style="cursor:pointer; opacity: 0.4;">[ 註銷帳號 (Delete) ]</small>
    </div>
  </div>

  <!-- 3. 遊戲畫面 -->
  <div id="view-game" class="view">
    <div class="back-btn" onclick="abortGame()">中止訓練 (Back)</div>
    <div id="hud">
      <div>TIME: <span id="time-val">20</span></div>
      <div>AGENT: <span id="agent-display">---</span></div>
      <div>SCORE: <span id="score-val">0</span></div>
    </div>
    <div id="game-canvas"></div>
  </div>

  <script>
    let globalUser = ""; // 用於全域存取的玩家名稱
    let gameScore = 0;
    let timer;

    // 切換頁面
    function goToView(id) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if(id === 'view-lobby') loadLeaderboard();
    }

    // 授權登入
    function handleAuth() {
      const name = document.getElementById('reg-name').value;
      if(!name) return;
      google.script.run.withSuccessHandler(res => {
        if(res.success) {
          globalUser = res.user;
          alert(res.msg);
          goToView('view-lobby');
        }
      }).registerUser(name);
    }

    // 讀取排行榜
    function loadLeaderboard() {
      google.script.run.withSuccessHandler(data => {
        let h = '<table>';
        data.forEach((p, i) => h += `<tr><td>${i+1}</td><td>${p.name}</td><td style="text-align:right">${p.score}</td></tr>`);
        document.getElementById('lb-data').innerHTML = h + '</table>';
      }).getLeaderboard();
    }

    // 刪除帳號
    function handleDelete() {
      if(!globalUser) return;
      if(confirm("確定刪除特工資料？這將無法恢復。")) {
        google.script.run.withSuccessHandler(msg => {
          alert(msg);
          location.reload();
        }).deleteAccount(globalUser);
      }
    }

    // 音效
    const aCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f, d) {
      const o = aCtx.createOscillator();
      const g = aCtx.createGain();
      o.frequency.value = f;
      g.gain.exponentialRampToValueAtTime(0.01, aCtx.currentTime + d);
      o.connect(g); g.connect(aCtx.destination);
      o.start(); o.stop(aCtx.currentTime + d);
    }
  </script>

  <!-- 匯入第二個獨立 HTML 檔案：遊戲邏輯 -->
  <?!= include('game_logic'); ?>

</body>
</html>
